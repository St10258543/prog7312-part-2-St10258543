@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@{
    // Set page title using localized string
    ViewData["Title"] = Localizer["ReportIssuesTitle"];
}

<!-- <Section: Hero Section> -->
<div class="issue-hero-section" style="background-image: url('/Images/issues-index.jpeg');">
    <!-- Overlay for better readability -->
    <div class="overlay"></div>

    <!-- Hero content: page title and description -->
    <div class="issue-hero-content">
        <h1 class="app-title">@Localizer["ReportIssuesTitle"]</h1>
        <p class="app-description">@Localizer["ReportIssuesDescription"]</p>
    </div>
</div>

<!-- <Section: Report Form Wrapper> -->
<div class="report-wrapper container">

    <!-- Display success message after submission -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- <Section: Report Form> -->
    <div class="report-card">
        <form id="reportForm" method="post" enctype="multipart/form-data" 
              asp-controller="Issues" asp-action="SubmitReport">

            <!-- <Section: Location Address Fields> -->
            <div class="form-group">
                <label for="location">@Localizer["Location"]</label>
                <textarea id="location" name="location" class="form-control" rows="4"
                          placeholder="Street Address&#10;City&#10;State/Province&#10;ZIP/Postal Code"
                          title="Enter the complete address" required></textarea>
                <small class="form-text text-muted">
                </small>
            </div>

            <!-- <Row: Category Input> -->
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="category">@Localizer["Category"]</label>
                    <select id="category" name="category" class="form-control" required>
                        <option value="">-- @Localizer["SelectCategory"] --</option>
                        <option value="Sanitation">@Localizer["Sanitation"]</option>
                        <option value="Roads">@Localizer["Roads"]</option>
                        <option value="Utilities">@Localizer["Utilities"]</option>
                        <option value="Other">@Localizer["Other"]</option>
                    </select>
                </div>
            </div>

            <!-- <Textarea: Issue Description> -->
            <div class="form-group">
                <label for="description">@Localizer["Description"]</label>
                <textarea id="description" name="description" class="form-control" rows="5"
                          placeholder="@Localizer["DescribeIssuePlaceholder"]" required></textarea>
            </div>

            <!-- <File Upload: Attach Media> -->
            <div class="form-group">
                <label for="media">@Localizer["AttachMedia"]</label>
                <div class="custom-file-input-wrapper d-flex align-items-center p-2">
                    <input type="file" id="media" name="media" multiple style="display:none" />
                    <button type="button" class="btn btn-outline-secondary me-2" id="mediaButton">
                        @Localizer["ChooseFileButton"]
                    </button>
                    <span id="mediaLabel" aria-live="polite">@Localizer["NoFileChosen"]</span>
                </div>
            </div>

            <!-- <Progress Bar: Report Completion> -->
            <div class="form-group">
                <label>@Localizer["ReportProgress"]</label>
                <div class="progress mt-1" style="height: 20px;">
                    <div id="progressBar" class="progress-bar bg-danger" role="progressbar"
                         style="width:0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        0%
                    </div>
                </div>
            </div>

            <!-- <Form Buttons: Back and Submit> -->
            <div class="form-buttons mt-3">
                <button type="button" class="btn btn-secondary me-2" id="backBtn">
                    @Localizer["BackButton"]
                </button>
                <button type="submit" class="btn btn-primary">
                    @Localizer["SubmitReportButton"]
                </button>
            </div>

        </form>
    </div>
</div>

<!-- <Script Section: File Input & Progress Bar Functionality> -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const mediaInput = document.getElementById('media');
        const mediaButton = document.getElementById('mediaButton');
        const mediaLabel = document.getElementById('mediaLabel');
        const progressBar = document.getElementById('progressBar');
        const formInputs = ["location", "category", "description"];

        // Trigger file input when button is clicked
        mediaButton.addEventListener('click', () => mediaInput.click());

        // Display selected file names
        mediaInput.addEventListener('change', () => {
            const files = Array.from(mediaInput.files);
            mediaLabel.textContent = files.length > 0 ? files.map(f => f.name).join(", ") : '@Localizer["NoFileChosen"]';
            updateProgress();
        });

        // Update progress bar when form fields change
        formInputs.forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', updateProgress);
            el.addEventListener('change', updateProgress);
        });

        function updateProgress() {
            let progress = 0;
            if (document.getElementById("location").value.trim() !== "") progress += 20;
            if (document.getElementById("category").value !== "") progress += 20;
            if (document.getElementById("description").value.trim() !== "") progress += 30;
            if (mediaInput.files.length > 0) progress += 30;

            progressBar.style.width = progress + "%";
            progressBar.innerText = progress + "%";

            if (progress < 40) progressBar.className = "progress-bar bg-danger";
            else if (progress < 80) progressBar.className = "progress-bar bg-warning";
            else progressBar.className = "progress-bar bg-success";
        }

        // Initialize progress bar on page load
        updateProgress();

        // Back button functionality
        document.getElementById("backBtn").addEventListener("click", function () {
            if (window.history.length > 1) window.history.back();
            else window.location.href = '@Url.Action("Index","Home")';
        });
    });
</script>